!function(e,t,n){e.fn.scrollParent||(e.fn.scrollParent=function(){var t=/(auto|scroll)/,n=this.css("position"),a="absolute"===n,o=this.parents().filter(function(){var n=e(this);return a&&"static"===n.css("position")?!1:t.test(n.css("overflow")+n.css("overflow-y")+n.css("overflow-x"))}).eq(0);return"fixed"!==n&&o.length?o:e(this[0].ownerDocument||document)});var a,o=function(){var e=function(e){return e&&"none"!=e?e.match(/(-?[0-9\.]+)/g):[1,0,0,1,0,0]},t=function(e){return e.css("-webkit-transform")||e.css("transform")||e.css("-moz-transform")||e.css("-o-transform")||e.css("-ms-transform")},n=function(n){var a=t(n);return e(a)},a=function(e,t){e.css("-webkit-transform",t),e.css("-moz-transform",t),e.css("-o-transform",t),e.css("-ms-transform",t),e.css("transform",t)},o=function(e){return"matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},i=function(e){var t=n(e);return{x:parseInt(t[4]),y:parseInt(t[5])}},l=function(e,t){var i=n(e);i[0]=i[3]=t;var l=o(i);a(e,l)},c=function(e,t,i){var l=n(e);l[4]=t,l[5]=i;var c=o(l);a(e,c)},r=function(e,t){var i=n(e),l=t*(Math.PI/180),c=-1*l;i[1]=l,i[2]=c;var r=o(i);a(e,r)};return{scale:l,translate:c,rotate:r,getTranslate:i}}(),i="MacIntel"==n.navigator.platform,l=0,c=0,r={command:!1,shift:!1,isSelecting:!1},s={66:"bold",73:"italic",85:"underline",112:"h1",113:"h2",122:"undo"},d={keyboard:{isCommand:function(e,t,n){i&&e.metaKey||!i&&e.ctrlKey?t():n()},isShift:function(e,t,n){e.shiftKey?t():n()},isModifier:function(e,t){var n=e.which,a=s[n];a&&t.call(this,a)},isEnter:function(e,t){13===e.which&&t()},isArrow:function(e,t){(e.which>=37&&e.which<=40||8==e.which||46==e.which)&&t()}},html:{addTag:function(n,a,o,i){var l=e(t.createElement(a));return l.attr("contenteditable",Boolean(i)),l.append(" "),n.append(l),o&&(r.focusedElement=n.children().last(),d.cursor.set(n,0,r.focusedElement)),l}},cursor:{set:function(e,a,o){var i;if(t.createRange){i=t.createRange();var l=n.getSelection(),c=e.children().last(),r=c.html().length-1,s=o?o[0]:c[0],d="undefined"!=typeof a?a:r;i.setStart(s,d),i.collapse(!0),l.removeAllRanges(),l.addRange(i)}else i=t.body.createTextRange(),i.moveToElementText(o),i.collapse(!1),i.select()}},selection:{save:function(){if(n.getSelection){var e=n.getSelection();if(e.rangeCount>0)return e.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restore:function(e){if(e)if(n.getSelection){var a=n.getSelection();a.removeAllRanges(),a.addRange(e)}else t.selection&&e.select&&e.select()},getText:function(){var e="";return n.getSelection?e=n.getSelection().toString():t.getSelection?e=t.getSelection().toString():t.selection&&(e=t.selection.createRange().text),e},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getContainer:function(e){return n.getSelection&&e&&e.commonAncestorContainer?e.commonAncestorContainer:t.selection&&e&&e.parentElement?e.parentElement():null},getSelection:function(){return n.getSelection?n.getSelection():t.selection&&t.selection.createRange?t.selection:null}},validation:{isUrl:function(e){return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(e)}}},u={updatePos:function(t,a){var i=n.getSelection(),l=i.getRangeAt(0),c=l.getBoundingClientRect(),r=a.outerWidth(),s=a.outerHeight(),d=Math.round(c.left+c.width/2-r/2),u=c.top-s-8,h=Math.max(0-d,0)-Math.max(d+r-e(document).width(),0),f={x:d+h,y:u};o.translate(a,f.x,f.y),a.find(".triangle").css("left",r/2-h+"px")},updateState:function(e,t){t.find("button").removeClass("active");var a=n.getSelection(),o=[];u.checkForFormatting(a.focusNode,o);for(var i={b:"bold",i:"italic",u:"underline",h1:"h1",h2:"h2",a:"anchor",ul:"ul",ol:"ol"},l=0;l<o.length;l++){var c=o[l];t.find("button."+i[c]).addClass("active")}},checkForFormatting:function(e,t){var n=["b","i","u","h1","h2","ol","ul","li","a"];("#text"===e.nodeName||-1!=n.indexOf(e.nodeName.toLowerCase()))&&("#text"!=e.nodeName&&t.push(e.nodeName.toLowerCase()),u.checkForFormatting(e.parentNode,t))},buildMenu:function(t,n){var o=d.html.addTag(n,"ul",!1,!1);for(var i in a.modifiers){var l=d.html.addTag(o,"li",!1,!1),c=d.html.addTag(l,"button",!1,!1);c.attr("editor-command",a.modifiers[i]),c.addClass(a.modifiers[i])}n.find("button").click(function(n){n.preventDefault();var a=e(this).attr("editor-command");m.commands[a].call(t,n)});var r=d.html.addTag(n,"div",!1,!1);r.addClass("link-area");var s=d.html.addTag(r,"input",!1,!1);s.attr({type:"text"});var u=d.html.addTag(r,"button",!1,!1);u.click(function(t){t.preventDefault();e(this).closest(".editor");e(this).closest(".link-area").hide(),e(this).closest(".bubble").find("ul").show()})},show:function(){if("true"===e(this).attr("contenteditable")){var t=e(this).parent().find(".bubble");t.length||(t=d.html.addTag(e(this).parent(),"div",!1,!1),t.addClass("jquery-notebook bubble")),t.empty();var n=d.html.addTag(t,"div",!1,!1);n.addClass("triangle"),u.buildMenu(this,t),t.show(),u.updateState(this,t),t.hasClass("active")?t.removeClass("jump"):t.addClass("jump"),u.updatePos(e(this),t),t.addClass("active")}},update:function(){var t=e(this).parent().find(".bubble");u.updateState(this,t)},clear:function(){var t=e(this).parent().find(".bubble");t.hasClass("active")&&(t.removeClass("active"),setTimeout(function(){t.hasClass("active")||t.hide()},500))},hideButtons:function(){e(this).parent().find(".bubble").find("ul").hide()},showButtons:function(){e(this).parent().find(".bubble").find("ul").show()},showLinkInput:function(t){u.hideButtons.call(this);var n=this,a=e(this).parent().find(".bubble").find("input[type=text]"),o=a.closest(".jquery-notebook").find("button.anchor").hasClass("active");a.unbind("keydown"),a.keydown(function(a){var i=e(this);d.keyboard.isEnter(a,function(){a.preventDefault();var e=i.val();d.validation.isUrl(e)?(a.url=e,m.commands.createLink(a,t),u.clear.call(n)):""===e&&o&&(m.commands.removeLink(a,t),u.clear.call(n))})}),a.bind("paste",function(t){var n=e(this);setTimeout(function(){var e=n.val();/http:\/\/https?:\/\//.test(e)&&(e=e.substring(7),n.val(e))},1)});var i="http://";if(o){var l=e(d.selection.getContainer(t)).closest("a");i=l.prop("href")||i}e(this).parent().find(".link-area").show(),a.val(i).focus()},hideLinkInput:function(){e(this).parent().find(".bubble").find(".link-area").hide()}},h={bindEvents:function(t){t.keydown(f.keydown),t.keyup(f.keyup),t.keypress(f.keypress),t.focus(f.focus),t.bind("paste",m.paste),t.mousedown(f.mouseClick),t.mouseup(f.mouseUp),t.mousemove(f.mouseMove),t.blur(f.blur),e("body").mouseup(function(n){n.target==n.currentTarget&&r.isSelecting?f.mouseUp.call(t,n):e(n.target).closest(".bubble").length||u.clear.call(t.not(e(n.target).closest(t)))}),t.each(function(){var t=e(this);t.scrollParent().scroll(function(){var e=t.parent().find(".bubble");e.hasClass("active")&&u.updatePos(t,e)})})},setPlaceholder:function(t){if("paragraphs"===a.mode&&/^\s*$/.test(e(this).text())){e(this).empty();var n=d.html.addTag(e(this),a.basetag,"undefined"!=typeof t.focus?t.focus:!1,!0);n.empty().attr("data-editor-placeholder",e(this).attr("data-editor-placeholder"))}},removePlaceholder:function(t){e(this).children().removeAttr("data-editor-placeholder")},preserveElementFocus:function(){var e=n.getSelection()?n.getSelection().anchorNode:t.activeElement;if(e){var a=e.parentNode,o=a!==r.focusedElement,i=this.children,l=0;a===this&&(a=e);for(var c=0;c<i.length;c++)if(a===i[c]){l=c;break}o&&(r.focusedElement=a,r.focusedElementIndex=l)}},setContentArea:function(t){var n=e("body").find(".jquery-editor").length+1;t.attr("data-jquery-notebook-id",n);var a=e("body");contentArea=e("<textarea></textarea>"),contentArea.css({position:"absolute",left:-1e3}),contentArea.attr("id","jquery-notebook-content-"+n),a.append(contentArea)},prepare:function(t,n){if(a=n,h.setContentArea(t),t.each(function(){e(this).attr("data-editor-placeholder")||e(this).attr("data-editor-placeholder",a.placeholder)}),t.attr("contenteditable",!0),t.css("position","relative"),t.addClass("jquery-notebook editor"),h.setPlaceholder.call(t,{}),h.preserveElementFocus.call(t),a.autoFocus===!0){var o=t.children();d.cursor.set(t,0,o)}"inline"===a.mode?(a.basetag="span",a.modifiers||(a.modifiers=["bold","italic","underline","anchor"])):"multiline"===a.mode?(a.basetag="div",a.modifiers||(a.modifiers=["bold","italic","underline","ol","ul","anchor"])):(a.basetag="p",a.modifiers||(a.modifiers=["bold","italic","underline","h1","h2","ol","ul","anchor"]))}},f={keydown:function(e){var t=this;r.command&&65===e.which&&setTimeout(function(){u.show.call(t)},50),d.keyboard.isCommand(e,function(){r.command=!0},function(){r.command=!1}),d.keyboard.isShift(e,function(){r.shift=!0},function(){r.shift=!1}),d.keyboard.isModifier.call(this,e,function(t){r.command&&m.commands[t].call(this,e)}),r.shift?d.keyboard.isArrow.call(this,e,function(){setTimeout(function(){var e=d.selection.getText();""!==e?u.show.call(t):u.clear.call(t)},100)}):d.keyboard.isArrow.call(this,e,function(){u.clear.call(t)}),13===e.which&&m.enterKey.call(this,e),27===e.which&&u.clear.call(this),86===e.which&&r.command,90===e.which&&r.command&&m.commands.undo.call(this,e)},keyup:function(t){d.keyboard.isCommand(t,function(){r.command=!1},function(){r.command=!0}),h.preserveElementFocus.call(this),h.removePlaceholder.call(this),""===e(this).text()&&(e(this).empty(),h.setPlaceholder.call(this,{focus:!0})),m.change.call(this)},keypress:function(e){u.clear.call(this)},focus:function(e){r.command=!1,r.shift=!1},mouseClick:function(t){if(r.isSelecting=!0,e(this).parent().find(".bubble:visible").length){var n=e(this).parent().find(".bubble:visible"),a=n.offset().left,o=n.offset().top,i=n.width(),s=n.height();if(l>a&&a+i>l&&c>o&&o+s>c)return}},mouseUp:function(e){var t=this;r.isSelecting=!1,setTimeout(function(){var n=d.selection.save();n&&(n.collapsed?u.clear.call(t):(u.show.call(t),e.preventDefault()))},50)},mouseMove:function(e){l=e.pageX,c=e.pageY},blur:function(e){h.setPlaceholder.call(this,{focus:!1})}},m={commands:{bold:function(e){e.preventDefault(),t.execCommand("bold",!1),u.update.call(this),m.change.call(this)},italic:function(e){e.preventDefault(),t.execCommand("italic",!1),u.update.call(this),m.change.call(this)},underline:function(e){e.preventDefault(),t.execCommand("underline",!1),u.update.call(this),m.change.call(this)},anchor:function(e){e.preventDefault();var t=d.selection.save();u.showLinkInput.call(this,t),m.change.call(this)},createLink:function(e,n){d.selection.restore(n),t.execCommand("createLink",!1,e.url),u.update.call(this),m.change.call(this)},removeLink:function(t,n){var a=e(d.selection.getContainer(n)).closest("a");a.contents().first().unwrap(),m.change.call(this)},h1:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h1")?t.execCommand("formatBlock",!1,"<"+a.basetag+">"):t.execCommand("formatBlock",!1,"<h1>"),u.update.call(this),m.change.call(this)},h2:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h2")?t.execCommand("formatBlock",!1,"<"+a.basetag+">"):t.execCommand("formatBlock",!1,"<h2>"),u.update.call(this),m.change.call(this)},ul:function(e){e.preventDefault(),t.execCommand("insertUnorderedList",!1),u.update.call(this),m.change.call(this)},ol:function(e){e.preventDefault(),t.execCommand("insertOrderedList",!1),u.update.call(this),m.change.call(this)},undo:function(a){a.preventDefault(),t.execCommand("undo",!1);var o=n.getSelection(),i=o.getRangeAt(0),l=i.getBoundingClientRect();e(document).scrollTop(e(document).scrollTop()+l.top),m.change.call(this)}},enterKey:function(t){if("inline"===a.mode)return t.preventDefault(),void t.stopPropagation();var n=d.selection.getSelection(),o=e(n.focusNode.parentElement),i=o.next();if(!i.length&&"LI"!=o.prop("tagName")){var l=o.prop("tagName");if("OL"===l||"UL"===l){var c=o.children().last();c.length&&""===c.text()&&(c.remove(),o.after(d.html.addTag(o,a.basetag,!0,!0)),d.cursor.set(o,0,r.focusedElement),t.preventDefault(),t.stopPropagation())}var s=n.focusNode==this||n.focusOffset==n.focusNode.length;s&&"paragraphs"===a.mode&&(d.html.addTag(e(this),a.basetag,!0,!0),t.preventDefault(),t.stopPropagation())}m.change.call(this)},paste:function(e){e.preventDefault();for(var n="",o=e.originalEvent.clipboardData.getData("Text").split("\n"),i=0;i<o.length;i++)n+=["<"+a.basetag+">",o[i],"</"+a.basetag+">"].join("");t.execCommand("insertHTML",!1,n),m.change.call(this)},change:function(t){var n=e("#jquery-notebook-content-"+e(this).attr("data-jquery-notebook-id"));n.val(e(this).html());var a=n.val(),o=new CustomEvent("contentChange",{detail:{content:a}});this.dispatchEvent(o)}};e.fn.notebook=function(t){return this.length&&(t=e.extend({},e.fn.notebook.defaults,t),h.prepare(this,t),h.bindEvents(this)),this},e.fn.notebook.defaults={autoFocus:!1,placeholder:"Your text here...",mode:"paragraphs"}}(jQuery,document,window);